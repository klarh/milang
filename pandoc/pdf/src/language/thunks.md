[Header 1 ("thunks--laziness", [], []) [Str "Thunks & Laziness"], Para [Str "Milang is ", Strong [Str "eager by default"], Str " — every expression is evaluated as soon as it is", SoftBreak, Str "bound. The tilde operator ", Code ("", [], []) "~", Str " lets you opt into delayed evaluation where you", SoftBreak, Str "need it."], Header 2 ("creating-thunks-with-", ["unnumbered", "unlisted"], []) [Str "Creating thunks with ", Code ("", [], []) "~"], Para [Str "Prefixing an expression with ", Code ("", [], []) "~", Str " wraps it in a ", Emph [Str "thunk"], Str ": a suspended computation", SoftBreak, Str "that is not executed until its value is actually needed."], CodeBlock ("", ["milang"], []) "eager = 1 + 2       -- evaluated immediately
delayed = ~(1 + 2)  -- wrapped in a thunk; not yet evaluated
result = delayed     -- forced here: evaluates to 3
", CodeBlock ("", [""], []) "eager = 3
delayed = 3
result = 3
", Para [Str "When a thunk is used in a context that needs its value (passed to an operator,", SoftBreak, Str "printed, pattern-matched, etc.) it is ", Emph [Str "forced"], Str " automatically — you never call a", SoftBreak, Str "thunk explicitly."], Header 2 ("if-and-auto-quote-parameters", ["unnumbered", "unlisted"], []) [Code ("", [], []) "if", Str " and auto-quote parameters"], Para [Str "In earlier versions of milang, ", Code ("", [], []) "if", Str " required explicit thunks on both branches", SoftBreak, Str "to prevent eager evaluation:"], CodeBlock ("", ["milang"], []) "-- Old style (still works, but no longer necessary):
result = if (x > 5) (x * 2) (x * 3)
", Para [Str "The ", Code ("", [], []) "if", Str " conditional quotes its branches implicitly; write conditionals like this:"], CodeBlock ("", ["milang"], []) "x = 10
result = if (x > 5) (x * 2) (x * 3)
", CodeBlock ("", [""], []) "x = 10
result = 20
", Para [Str "Both styles work — if you pass a thunk to an auto-quote parameter, the thunk", SoftBreak, Str "is forced after splicing. See the ", Link ("", [], []) [Str "Metaprogramming"] ("/home/matthew/dev/milang-copilot/docs-out/pandoc/pdf/src/language/metaprogramming.md#metaprogramming", ""), Str " chapter", SoftBreak, Str "for details on ", Code ("", [], []) "#", Str "-params."], Header 2 ("nested-conditionals", ["unnumbered", "unlisted"], []) [Str "Nested conditionals"], Para [Str "Conditionals compose naturally:"], CodeBlock ("", ["milang"], []) "z = 7
result = if (z > 10) 100 (if (z > 5) 50 0)
", CodeBlock ("", [""], []) "z = 7
result = 50
", Para [Str "Each inner ", Code ("", [], []) "if", Str " is only evaluated when its enclosing branch is selected."], Header 2 ("lazy-bindings-with-", ["unnumbered", "unlisted"], []) [Str "Lazy bindings with ", Code ("", [], []) ":="], Para [Str "The ", Code ("", [], []) ":=", Str " operator creates a ", Emph [Str "lazy binding"], Str " — syntactic sugar for a thunk that", SoftBreak, Str "caches its result after the first force:"], CodeBlock ("", ["milang"], []) "x = 3
y := x + 10   -- not evaluated until y is used
z = y * 2     -- forces y here; y becomes 13, z becomes 26
", CodeBlock ("", [""], []) "x = 3
y = <closure>
z = 26
", Para [Str "Lazy bindings are useful for expensive computations that may never be needed, or", SoftBreak, Str "for establishing declaration-order dependencies without paying upfront cost."], Header 2 ("when-to-use-thunks", ["unnumbered", "unlisted"], []) [Str "When to use thunks"], Table ("", [], []) (Caption Nothing []) [(AlignDefault, (ColWidth 0.5)), (AlignDefault, (ColWidth 0.5))] (TableHead ("", [], []) [Row ("", [], []) [Cell ("", [], []) AlignDefault (RowSpan 0) (ColSpan 0) [Plain [Str "Situation"]], Cell ("", [], []) AlignDefault (RowSpan 0) (ColSpan 0) [Plain [Str "Mechanism"]]]]) [(TableBody ("", [], []) (RowHeadColumns 0) [] [Row ("", [], []) [Cell ("", [], []) AlignDefault (RowSpan 0) (ColSpan 0) [Plain [Str "Conditional branches (", Code ("", [], []) "if", Str ")"]], Cell ("", [], []) AlignDefault (RowSpan 0) (ColSpan 0) [Plain [Str "Auto-quoted branch parameters handle this"]]], Row ("", [], []) [Cell ("", [], []) AlignDefault (RowSpan 0) (ColSpan 0) [Plain [Str "Short-circuit logic (", Code ("", [], []) "&&", Str ", ", Code ("", [], []) "||", Str ")"]], Cell ("", [], []) AlignDefault (RowSpan 0) (ColSpan 0) [Plain [Str "Auto-quote params handle the lazy operand"]]], Row ("", [], []) [Cell ("", [], []) AlignDefault (RowSpan 0) (ColSpan 0) [Plain [Str "Deferred expensive work"]], Cell ("", [], []) AlignDefault (RowSpan 0) (ColSpan 0) [Plain [Str "Lazy binding ", Code ("", [], []) ":="]]], Row ("", [], []) [Cell ("", [], []) AlignDefault (RowSpan 0) (ColSpan 0) [Plain [Str "Controlling IO ordering"]], Cell ("", [], []) AlignDefault (RowSpan 0) (ColSpan 0) [Plain [Str "Thunks delay side effects until forced"]]]])] (TableFoot ("", [], []) []), Para [Str "The general rule: reach for ", Code ("", [], []) "~", Str " whenever you need to ", Strong [Str "control when"], Str " an", SoftBreak, Str "expression is evaluated rather than relying on milang's default left-to-right", SoftBreak, Str "eager order."]]