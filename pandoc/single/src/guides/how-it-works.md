[Header 1 ("how-milang-works", [], []) [Str "How Milang Works"], Para [Str "Milang's compilation pipeline has four stages:"], CodeBlock ("", ["bash"], []) "source.mi -> Parser -> Import Resolution -> Partial Evaluator -> C Codegen -> gcc
", Para [Str "Each stage is a pure transformation of the AST, except for import resolution (which reads files and URLs) and the final gcc invocation."], Header 2 ("1-parser", ["unnumbered", "unlisted"], []) [Str "1. Parser"], Para [Str "The parser is indentation-sensitive — nested blocks are determined by whitespace, similar to Haskell or Python."], Para [Str "There are ", Strong [Str "zero keywords"], Str " in milang. Everything that looks like a keyword — ", Code ("", [], []) "if", Str ", ", Code ("", [], []) "import", Str ", ", Code ("", [], []) "true", Str ", ", Code ("", [], []) "false", Str " — is actually a function or value defined in the prelude. The parser only needs to recognize:"], BulletList [[Plain [Strong [Str "Bindings"], Str " across five annotation domains: ", Code ("", [], []) "=", Str " (value), ", Code ("", [], []) "::", Str " (type), ", Code ("", [], []) ":~", Str " (traits), ", Code ("", [], []) ":?", Str " (docs), ", Code ("", [], []) ":!", Str " (parse)"]], [Plain [Strong [Str "Expressions"], Str ": literals, application, operators, lambdas, records, lists, pattern match (", Code ("", [], []) "->", Str ")"]], [Plain [Strong [Str "Operators"], Str ": parsed with configurable precedence (", Code ("", [], []) ":!", Str " declarations can define new ones)"]]], Para [Str "The output is a single ", Code ("", [], []) "Expr", Str " AST type with variants like ", Code ("", [], []) "IntLit", Str ", ", Code ("", [], []) "App", Str ", ", Code ("", [], []) "Lam", Str ", ", Code ("", [], []) "Namespace", Str ", ", Code ("", [], []) "Record", Str ", ", Code ("", [], []) "Match", Str ", and so on."], Header 2 ("2-import-resolution", ["unnumbered", "unlisted"], []) [Str "2. Import Resolution"], Para [Str "When the parser encounters ", Code ("", [], []) "import \"path.mi\"", Str ", the import resolver:"], OrderedList (1, DefaultStyle, DefaultDelim) [[Plain [Strong [Str "Reads the file"], Str " (local path or URL)"]], [Plain [Strong [Str "Parses it"], Str " into an AST"]], [Plain [Strong [Str "Recursively resolves"], Str " its imports"]], [Plain [Strong [Str "Returns a record"], Str " of the module's exported bindings"]]], Para [Str "Import types:"], Table ("", [], []) (Caption Nothing []) [(AlignDefault, (ColWidth 0.5)), (AlignDefault, (ColWidth 0.5))] (TableHead ("", [], []) [Row ("", [], []) [Cell ("", [], []) AlignDefault (RowSpan 0) (ColSpan 0) [Plain [Str "Syntax"]], Cell ("", [], []) AlignDefault (RowSpan 0) (ColSpan 0) [Plain [Str "Source"]]]]) [(TableBody ("", [], []) (RowHeadColumns 0) [] [Row ("", [], []) [Cell ("", [], []) AlignDefault (RowSpan 0) (ColSpan 0) [Plain [Code ("", [], []) "import \"lib/utils.mi\""]], Cell ("", [], []) AlignDefault (RowSpan 0) (ColSpan 0) [Plain [Str "Local file (relative to importing file)"]]], Row ("", [], []) [Cell ("", [], []) AlignDefault (RowSpan 0) (ColSpan 0) [Plain [Code ("", [], []) "import \"https://example.com/lib.mi\""]], Cell ("", [], []) AlignDefault (RowSpan 0) (ColSpan 0) [Plain [Str "URL (downloaded and cached)"]]], Row ("", [], []) [Cell ("", [], []) AlignDefault (RowSpan 0) (ColSpan 0) [Plain [Code ("", [], []) "import \"/usr/include/math.h\""]], Cell ("", [], []) AlignDefault (RowSpan 0) (ColSpan 0) [Plain [Str "C header (extracts function signatures for FFI)"]]]])] (TableFoot ("", [], []) []), Para [Strong [Str "URL security:"], Str " URL imports must be pinned with a SHA-256 hash using ", Code ("", [], []) "import'", Str " and a hash record. The ", Code ("", [], []) "milang pin", Str " command fetches imports and writes the hashes back into your source file. The hash covers the content of the import and all of its transitive sub-imports (a Merkle hash), so any tampering is detected."], Para [Strong [Str "Circular imports"], Str " are handled by returning only the non-import bindings from the cycle and marking the recursive reference as a lazy thunk."], Header 2 ("3-partial-evaluator", ["unnumbered", "unlisted"], []) [Str "3. Partial Evaluator"], Para [Str "The partial evaluator is the heart of the compiler. It walks the AST and ", Strong [Str "reduces every expression it can"], Str " given the values it knows at compile time."], Para [Str "Consider:"], CodeBlock ("", ["milang"], []) "double x = x * 2
y = double 21
", CodeBlock ("", [""], []) "double = <closure>
y = 42
", Para [Str "The partial evaluator sees that ", Code ("", [], []) "double", Str " is fully known and ", Code ("", [], []) "21", Str " is a literal, so it evaluates ", Code ("", [], []) "double 21", Str " at compile time. The result in the reduced AST is simply ", Code ("", [], []) "y = 42", Str " — the function call has been eliminated entirely."], Para [Str "Key techniques:"], BulletList [[Plain [Strong [Str "Strongly Connected Component (SCC) analysis"], Str " — bindings are sorted by dependency so each group can be reduced in order."]], [Plain [Strong [Str "Depth-limited recursion"], Str " — recursive functions are unrolled a fixed number of times. If the result converges (reaches a base case), it becomes a compile-time constant. Otherwise, the function is left as runtime code."]], [Plain [Strong [Str "Environment threading"], Str " — the evaluator carries a map of known bindings. When a binding's value is fully determined, it's substituted into all uses."]]], Para [Str "The partial evaluator ", Strong [Str "is"], Str " the optimizer. There is no separate optimization pass. Any abstraction that is fully known at compile time — constants, configuration, helper functions applied to literals, record construction — is resolved to a value before code generation."], Header 2 ("4-c-code-generation", ["unnumbered", "unlisted"], []) [Str "4. C Code Generation"], Para [Str "The code generator takes the reduced AST and emits a single, self-contained C file. This file includes:"], BulletList [[Plain [Strong [Str "An embedded runtime"], Str " — an arena allocator, a tagged union value type (", Code ("", [], []) "MiVal", Str "), environment chains, and built-in functions."]], [Plain [Strong [Str "Arena allocation"], Str " — all milang values are allocated from 1 MB arena blocks with 8-byte alignment. There is no garbage collector; arenas are freed in bulk."]], [Plain [Strong [Str "Tagged unions"], Str " — every runtime value is a ", Code ("", [], []) "MiVal", Str " with a ", Code ("", [], []) "tag", Str " (", Code ("", [], []) "MI_INT", Str ", ", Code ("", [], []) "MI_FLOAT", Str ", ", Code ("", [], []) "MI_STRING", Str ", ", Code ("", [], []) "MI_CLOSURE", Str ", ", Code ("", [], []) "MI_RECORD", Str ", etc.) and a payload."]], [Plain [Strong [Str "Tail-call optimization"], Str " — ", Code ("", [], []) "tail", Str " calls are compiled to ", Code ("", [], []) "goto", Str " jumps, so recursive functions run in constant stack space."]], [Plain [Strong [Str "Closures"], Str " — functions that capture variables are represented as a code pointer plus an environment chain of bindings."]]], Para [Str "The generated C compiles with ", Code ("", [], []) "gcc", Str " (or ", Code ("", [], []) "clang", Str ") and links against the standard C library:"], CodeBlock ("", ["bash"], []) "gcc output.c -o program
", Header 2 ("the-key-insight", ["unnumbered", "unlisted"], []) [Str "The Key Insight"], Para [Str "Because the partial evaluator runs at compile time, ", Strong [Str "high-level abstractions often have zero runtime cost"], Str ". A chain of helper functions, a configuration record, a computed lookup table — if the inputs are known at compile time, none of that code exists in the generated binary. Only expressions that depend on runtime values (IO, user input, command-line arguments) survive into the emitted C."], Header 2 ("debugging-the-pipeline", ["unnumbered", "unlisted"], []) [Str "Debugging the Pipeline"], Para [Str "Two compiler commands let you inspect intermediate stages:"], BulletList [[Plain [Strong [Code ("", [], []) "milang dump file.mi"], Str " — shows the parsed AST before import resolution. Useful for checking how the parser interpreted your syntax."]], [Plain [Strong [Code ("", [], []) "milang reduce file.mi"], Str " — shows the AST after partial evaluation. This is what the code generator sees. Use it to verify that compile-time computation happened as expected."]]], CodeBlock ("", ["bash"], []) "./milang dump myfile.mi    # parsed AST
./milang reduce myfile.mi  # after partial evaluation
"]